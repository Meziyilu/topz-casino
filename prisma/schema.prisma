// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String
  name        String?
  balance     Int      @default(0) // 錢包
  bankBalance Int      @default(0) // 銀行
  createdAt   DateTime @default(now())

  bets Bet[]
}

enum BetSide {
  PLAYER
  BANKER
  TIE
  PLAYER_PAIR
  BANKER_PAIR
  ANY_PAIR
  PERFECT_PAIR
}

enum RoundOutcome {
  PLAYER
  BANKER
  TIE
}

enum RoundPhase {
  BETTING
  REVEAL
  SETTLED
}

enum RoomCode {
  R30 // 30秒房
  R60 // 60秒房
  R90 // 90秒房
}

model Room {
  id              String   @id @default(cuid())
  code            RoomCode @unique
  name            String
  durationSeconds Int
  createdAt       DateTime @default(now())

  rounds Round[]
  bets   Bet[]

  @@index([code])
}

/**
 * 每個房間每天的局序從 1 重新開始：
 * - 唯一鍵：(roomId, day, roundSeq)
 * - day：以台北當地日期 00:00 轉為 UTC 存入
 * - 牌面/對子等資訊以 Json/Boolean 保存，方便前端動畫與路子
 */
model Round {
  id       String   @id @default(cuid())
  roomId   String
  day      DateTime
  roundSeq Int

  phase       RoundPhase    @default(BETTING)
  outcome     RoundOutcome?
  playerTotal Int?
  bankerTotal Int?

  playerCards Json? // [{rank:1..13,suit:0..3}, ...]
  bankerCards Json?

  playerPair  Boolean?
  bankerPair  Boolean?
  anyPair     Boolean?
  perfectPair Boolean?

  startedAt DateTime // 回合開始 UTC
  settledAt DateTime? // 結算完成 UTC
  createdAt DateTime  @default(now())

  room Room  @relation(fields: [roomId], references: [id])
  bets Bet[]

  @@unique([roomId, day, roundSeq])
  @@index([roomId, day])
}

/**
 * 下注記錄：
 * - 指向房間 + 當日 + 局序（即使 Round 尚未持久化，也能先寫單）
 * - 若已有對應 Round，可一併寫 roundId
 */
model Bet {
  id       String   @id @default(cuid())
  userId   String
  roomId   String
  day      DateTime
  roundSeq Int

  side      BetSide
  amount    Int
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  room    Room    @relation(fields: [roomId], references: [id])
  round   Round?  @relation(fields: [roundId], references: [id])
  roundId String?

  @@index([userId, roomId, createdAt])
  @@index([roomId, day, roundSeq])
}
